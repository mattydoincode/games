var SnakeView=Backbone.View.extend({events:{"change #light":"changeColor"},settings:{gridX:50,gridY:0,gridColor:"#ddd",firstSnakeColor:"#68A9FF",restSnakeColor:"#004FFF",spotColor:"red",rate:80,maxInputs:4,startDirection:2,valueOfEating:4,numScores:5,darkColor:"#2C3E50",lightColor:"#FFFFFF"},initialize:function(){var e=this;_.bindAll(e,"render","renderGrid","renderSnake"),e.context=e.options.context,e.setUpDimensions(e.options.width,e.options.height),e.light=!0;if(moment().hours()>20||moment().hours()<6)$("#light").click(),e.changeColor();e.readScores(),e.paused=!1,$(window).keydown(function(t){e.registerInput(t.which)}),e.waiting=!0,e.render()},setUpDimensions:function(e,t){var n=this;n.width=e,n.height=t,n.settings.gridY=Math.round(n.settings.gridX*(n.height/n.width)),n.boxHeight=n.height/n.settings.gridY,n.boxWidth=n.width/n.settings.gridX},changeColor:function(){var e=this;e.light=!e.light,e.light?$(".canvasContainer").css("background",e.settings.lightColor):$(".canvasContainer").css("background",e.settings.darkColor)},readScores:function(){var e=this,t=Parse.Object.extend("HighScore"),n=new Parse.Query(t);n.limit(e.settings.numScores),n.descending("score"),n.equalTo("game","snake"),n.find({success:function(t){e.scores=t,e.displayScores()},error:function(e){alert("Error: "+e.code+" "+e.message)}})},displayScores:function(){var e=this,t="";_.each(e.scores,function(e,n){e.rank=n+1,e.username=e.attributes.username,e.username.length>19&&(e.username=e.username.substring(0,16)+"..."),e.score=e.attributes.score,t+=$.Mustache.render("score",e)}),$("#daScores").html(t)},startGame:function(){var e=this;e.snakeQueue=[],e.snakeQueue.push({x:20,y:5}),e.spotPlaced=!1,e.placeRandomSpot(),e.inputQueue=[],e.extras=0,e.score=0,e.inputs=[],e.up=0,e.down=0,e.left=0,e.right=0,e.direction=e.settings.startDirection,$(".container-fluid").hide(),e.c=Math.floor(Math.random()*1e3+1)+(new Date).getTime(),$.ajax({type:"GET",url:"/highscores",data:{c:e.c,q:"snake"},success:function(t){e.tmpKey=t}})},render:function(){var e=this;e.clearCanvas(),e.waiting?e.writeText():e.paused?e.writePauseText():(e.checkInputs(),e.moveSnake(),e.renderSnake(),e.writeScore()),setTimeout(function(){e.render()},e.settings.rate)},addScore:function(){var e=this,t=$("#username").val(),n=parseInt($("#newscore").html());if(t==""||n==0)return;$.ajax({type:"PUT",url:"/highscores",data:{k:e.tmpKey},headers:{"X-Here-We-Go":t,"X-Lets-Do-It":e.c%2==0?n+7:n+9},success:function(r){var i=crypto.hex_md5(e.c+r),s=crypto.hex_sha1(t+r),o=(new Date).getTime(),u=Math.floor(Math.random()*1e3+1),a="snake",f=dcodeIO.bcrypt.genSaltSync(),l=crypto.hex_sha1(""+o+n+t+u+a+i+f);$.ajax({type:"POST",url:"/highscores",headers:{"X-Try-Harder":s},data:{t:o,r:u,y:f,g:a,c:e.c,b:r,h:l},success:function(){e.readScores()}})}}),$("#newscore").html(""),$(".newscore-row").hide(),$(".lastscore-row").show()},gameOver:function(){var e=this;$("#lastscore").html(e.score),$("#newscore").html(e.score),e.score>e.scores[e.scores.length-1].score?($(".newscore-row").show(),$(".lastscore-row").hide()):$(".lastscore-row").show(),$(".container-fluid").fadeIn("slow")},writeText:function(){var e=this;e.context.font="30px Arial",e.context.fillStyle=e.light?e.settings.darkColor:e.settings.lightColor,e.context.fillText("press space to begin",e.width/5,e.height/2-15),e.context.font="15px Arial",e.context.fillText("use arrow keys or AWSD",e.width/5,e.height/2+40),e.context.fillText("during game, space pauses",e.width/5,e.height/2+60)},writePauseText:function(){var e=this;e.context.font="30px Arial",e.context.fillStyle=e.light?e.settings.darkColor:e.settings.lightColor,e.context.fillText("press space to continue",e.height/5,e.height/2-15)},writeScore:function(){var e=this;e.context.font="30px Arial",e.context.fillStyle=e.light?e.settings.darkColor:e.settings.lightColor,e.context.fillText(e.score,10,40)},placeRandomSpot:function(){var e=this,t=!1;while(!t){var e=this,n=Math.floor(Math.random()*e.settings.gridX),r=Math.floor(Math.random()*e.settings.gridY),t=!_.any(e.snakeQueue,function(e){return e.x==n&&e.y==r});e.spot={x:n,y:r}}},clearCanvas:function(){var e=this;e.context.clearRect(0,0,e.width,e.height)},registerInput:function(e){var t=this;e==32&&(t.waiting&&!$("#username").is(":focus")?(t.startGame(),t.waiting=!1):t.waiting||(t.paused=!t.paused)),e==37||e==65?t.left==0&&(t.left=1):e==38||e==87?t.up==0&&(t.up=1):e==39||e==68?t.right==0&&(t.right=1):e==40||e==83?t.down==0&&(t.down=1):e==13&&t.waiting&&t.addScore()},checkInputs:function(){var e=this;if(e.inputs.length>e.settings.maxInputs)return;e.left==1&&(e.left=0,e.inputs.push(0)),e.up==1&&(e.up=0,e.inputs.push(1)),e.right==1&&(e.right=0,e.inputs.push(2)),e.down==1&&(e.down=0,e.inputs.push(3))},moveSnake:function(){var e=this;if(e.inputs.length>0){var t=e.inputs.shift();if(t!=0||e.direction!=2)if(t!=1||e.direction!=3)if(t!=2||e.direction!=0)if(t!=3||e.direction!=1)e.direction=t}var n=e.snakeQueue[e.snakeQueue.length-1],r={x:n.x,y:n.y};e.direction==0?r.x--:e.direction==1?r.y--:e.direction==2?r.x++:e.direction==3&&r.y++,r.x==e.spot.x&&r.y==e.spot.y&&(e.score+=10,e.extras+=e.settings.valueOfEating,e.placeRandomSpot()),e.extras>0?e.extras--:e.snakeQueue.shift();var i=_.any(e.snakeQueue,function(e){return e.x==r.x&&e.y==r.y});if(r.x>=e.settings.gridX||r.x<0||r.y>=e.settings.gridY||r.y<0)i=!0;e.snakeQueue.push(r),i&&(e.waiting=!0,e.gameOver())},renderGrid:function(){var e=this;e.context.strokeStyle="#ddd";for(var t=0;t<e.settings.gridX;t++)for(var n=0;n<e.settings.gridY;n++)e.context.strokeRect(t*e.boxWidth,n*e.boxHeight,e.boxWidth,e.boxHeight)},renderSnake:function(){var e=this,t=!0;for(var n=e.snakeQueue.length-1;n>=0;n--){var r=e.snakeQueue[n];t?(e.context.fillStyle=e.settings.firstSnakeColor,t=!1,e.context.fillRect(r.x*e.boxWidth,r.y*e.boxHeight,e.boxWidth,e.boxHeight),e.context.fillStyle=e.settings.restSnakeColor):e.context.fillRect(r.x*e.boxWidth,r.y*e.boxHeight,e.boxWidth,e.boxHeight)}e.context.fillStyle=e.settings.spotColor,e.context.fillRect(e.spot.x*e.boxWidth,e.spot.y*e.boxHeight,e.boxWidth,e.boxHeight)}})